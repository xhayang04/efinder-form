<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <title>‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô - eFinder</title>
</head>
<body class="bg-black min-h-screen flex flex-col items-center justify-center px-4 py-6">

  <!-- ‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤ -->
  <div class="w-full max-w-md bg-zinc-900 text-white rounded-lg shadow-lg p-6 space-y-6 text-center">

    <!-- ‡πÇ‡∏•‡πÇ‡∏Å‡πâ -->
    <div class="flex justify-center">
      <img src="logo.png" alt="eFinder Logo" class="w-12 h-12" />
    </div>

    <!-- ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° -->
    <h2 class="text-xl font-bold">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</h2>
    <p class="text-zinc-400 text-sm">
      ‡πÄ‡∏£‡∏≤‡πÑ‡∏î‡πâ‡∏™‡πà‡∏á‡∏£‡∏´‡∏±‡∏™‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÑ‡∏õ‡∏ó‡∏µ‡πà
      <span id="emailDisplay" class="text-yellow-400 font-semibold">your@email.com</span>
    </p>

    <!-- ‡∏ä‡πà‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™ -->
    <div class="flex justify-center gap-2 mt-4">
      <input maxlength="1" class="otp-box w-10 h-12 text-center rounded-md bg-zinc-800 border border-yellow-400 text-xl" />
      <input maxlength="1" class="otp-box w-10 h-12 text-center rounded-md bg-zinc-800 border border-yellow-400 text-xl" />
      <input maxlength="1" class="otp-box w-10 h-12 text-center rounded-md bg-zinc-800 border border-yellow-400 text-xl" />
      <input maxlength="1" class="otp-box w-10 h-12 text-center rounded-md bg-zinc-800 border border-yellow-400 text-xl" />
      <input maxlength="1" class="otp-box w-10 h-12 text-center rounded-md bg-zinc-800 border border-yellow-400 text-xl" />
      <input maxlength="1" class="otp-box w-10 h-12 text-center rounded-md bg-zinc-800 border border-yellow-400 text-xl" />
    </div>

    <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô -->
    <button
      class="w-full mt-6 bg-yellow-400 hover:bg-yellow-500 text-black font-bold py-2 px-4 rounded"
      onclick="submitOTP()"
    >
      ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏≠‡∏µ‡πÄ‡∏°‡∏•
    </button>

    <!-- ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° error -->
    <p id="otpError" class="text-red-400 text-sm mt-2 hidden"></p>

    <!-- ‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏™‡∏≥‡∏£‡∏≠‡∏á -->
    <div class="text-sm text-zinc-400 mt-2">
      <p>‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏°? <button onclick="resendOTP()" class="text-yellow-400 hover:underline"> ‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡πÉ‡∏´‡∏°‡πà</button></p>
      <button onclick="goBack()" class="inline-block mt-2 text-zinc-400 hover:underline">‚Üê ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤</button>
    </div>
  </div>

  <script>
    // Auto focus ‡∏ï‡πà‡∏≠‡∏ä‡πà‡∏≠‡∏á + ‡∏•‡∏ö‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö + ‡∏•‡πâ‡∏≤‡∏á error
    document.querySelectorAll(".otp-box").forEach((input, idx, all) => {
      input.addEventListener("input", () => {
        if (input.value && idx < all.length - 1) all[idx + 1].focus();
        document.getElementById("otpError").classList.add("hidden");
      });

      input.addEventListener("keydown", (e) => {
        if (e.key === "Backspace" && !input.value && idx > 0) all[idx - 1].focus();
      });
    });

    function goBack() {
      const flow = localStorage.getItem("otpFlow");
      if (flow === "reset") {
        window.location.href = "reset-password.html";
      } else {
        window.location.href = "signup.html";
      }
    }

    function submitOTP() {
      const code = [...document.querySelectorAll(".otp-box")].map(el => el.value).join('');
      const errorBox = document.getElementById("otpError");

      if (code.length !== 6 || !/^\d{6}$/.test(code)) {
        errorBox.textContent = "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™ 6 ‡∏´‡∏•‡∏±‡∏Å‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö";
        errorBox.classList.remove("hidden");
        return;
      }

      const email = localStorage.getItem("otpEmail") || localStorage.getItem("userEmail");
      const otpSessionId = localStorage.getItem("otpSessionId");
      const otpFlow = localStorage.getItem("otpFlow");
      const newPassword = localStorage.getItem("otpNewPassword");

      if (!email || !otpSessionId || !otpFlow) {
        errorBox.textContent = "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà";
        errorBox.classList.remove("hidden");
        return;
      }

      const payload = {
        email,
        otp: code,
        otpSessionId,
        flow: otpFlow // üëà ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏≠‡∏Å‡∏ß‡πà‡∏≤ signup ‡∏´‡∏£‡∏∑‡∏≠ reset
      };

      if (otpFlow === "reset") {
        payload.newPassword = newPassword;
      }

      fetch("https://chayang-n8n-app.onrender.com/webhook/verify", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          localStorage.clear();
          window.location.href = "vendor-page_1.html";
        } else {
          let failCount = parseInt(localStorage.getItem("otpFailCount") || "0", 10);
          failCount++;

          if (failCount >= 3) {
            alert("‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏Å‡∏¥‡∏ô 3 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà");
            localStorage.clear();
            window.location.href = "vendor-page_1.html";
            return;
          }

          localStorage.setItem("otpFailCount", failCount.toString());
          errorBox.textContent = data.message || "‡∏£‡∏´‡∏±‡∏™ OTP ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á";
          errorBox.classList.remove("hidden");
        }
      })
      .catch(err => {
        console.error(err);
        errorBox.textContent = "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ";
        errorBox.classList.remove("hidden");
      });
    }

    const email = localStorage.getItem("otpEmail") || localStorage.getItem("userEmail");
    if (email) {
      document.getElementById("emailDisplay").textContent = email;
    }

    function resendOTP() {
      const email = localStorage.getItem("otpEmail") || localStorage.getItem("userEmail");
      const otpFlow = localStorage.getItem("otpFlow");

      if (!email || !otpFlow) {
        alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà");
        window.location.href = "vendor-page_1.html";
        return;
      }

      let resendCount = parseInt(localStorage.getItem("resendCount") || "0", 10);
      resendCount++;

      if (resendCount > 3) {
        alert("‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏î‡∏™‡πà‡∏á‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Å‡∏¥‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà");
        localStorage.clear();
        window.location.href = "vendor-page_1.html";
        return;
      }

      localStorage.setItem("resendCount", resendCount.toString());

      const webhook = otpFlow === "reset"
        ? "https://chayang-n8n-app.onrender.com/webhook/reset-password"
        : "https://chayang-n8n-app.onrender.com/webhook/signup";

      fetch(webhook, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email })
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          localStorage.setItem("otpSessionId", data.otpSessionId);
          alert(`‡∏™‡πà‡∏á‡∏£‡∏´‡∏±‡∏™ OTP ‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß (${resendCount}/3 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á)`);
        } else {
          alert(data.message || "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏£‡∏´‡∏±‡∏™‡πÉ‡∏´‡∏°‡πà");
        }
      })
      .catch(err => {
        console.error(err);
        alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ");
      });
    }
  </script>



</body>
</html>
